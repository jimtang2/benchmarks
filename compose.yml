services:
  postgres:
    image: postgres:17.5-alpine
    container_name: postgres-demo
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: demo
    command: 
      - postgres
      - -cmax_connections=4000
      - -cshared_buffers=6GB
      - -ceffective_cache_size=18GB
      - -cwork_mem=32MB
      - -cmaintenance_work_mem=2GB
      - -ccheckpoint_timeout=15min
      - -cmax_wal_size=8GB
      - -cmin_wal_size=2GB
      - -ccheckpoint_completion_target=0.9
      - -cwal_buffers=64MB
      - -cdefault_statistics_target=500
      - -crandom_page_cost=1.1
      - -ceffective_io_concurrency=200
      - -cmax_worker_processes=12
      - -cmax_parallel_workers_per_gather=4
      - -cmax_parallel_workers=12
      - -cwal_compression=on
      - -cwal_level=minimal
      - -cfull_page_writes=off
      - -cbgwriter_lru_maxpages=1000
      - -cbgwriter_delay=50ms
      - -cmax_wal_senders=0
      - -cmax_replication_slots=0
      - -carchive_mode=off
      - -carchive_timeout=0
    shm_size: 8gb
    deploy:
      resources:
        limits:
          memory: 24G
          cpus: '8'
    volumes:
      - ./sql:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"

  pgcat:
    image: ghcr.io/postgresml/pgcat:latest
    container_name: pgcat-demo
    restart: unless-stopped
    depends_on:
      - postgres
    ports:
      - "6432:6432"
    volumes:
      - ./pgcat.toml:/etc/pgcat/pgcat.toml:ro

  go-pq:
    image: jimtang2/benchmarks/go-pq
    build:
      context: .
      dockerfile: ./go/Dockerfile
      args:
        SOURCE_PATH: go/pq
    container_name: bench-go-pq
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  go-pgx:
    image: jimtang2/benchmarks/go-pgx
    build:
      context: .
      dockerfile: ./go/Dockerfile
      args:
        SOURCE_PATH: go/pgx
    container_name: bench-go-pgx
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  go-pgx-opt:
    image: jimtang2/benchmarks/go-pgx-opt
    build:
      context: .
      dockerfile: ./go/Dockerfile
      args:
        SOURCE_PATH: go/pgx-opt
    container_name: bench-go-pgx-opt
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  go-pgx-opt-pool:
    image: jimtang2/benchmarks/go-pgx-opt
    build:
      context: .
      dockerfile: ./go/Dockerfile
      args:
        SOURCE_PATH: go/pgx-opt
    container_name: bench-go-pgx-opt-pool
    ports:
      - "8080:8080"
    volumes:
      - ./config.with-pool.yaml:/config/config.yaml
    depends_on:
      - postgres

  fastapi-asyncpg:
    image: jimtang2/benchmarks/fastapi-asyncpg
    build:
      context: .
      dockerfile: ./fastapi/Dockerfile
      args:
        SOURCE_PATH: fastapi/asyncpg
    container_name: bench-fastapi-asyncpg
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  fastapi-psycopg:
    image: jimtang2/benchmarks/fastapi-psycopg
    build:
      context: .
      dockerfile: ./fastapi/Dockerfile
      args:
        SOURCE_PATH: fastapi/psycopg
    container_name: bench-fastapi-psycopg
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  fastapi-psycopg-pool:
    image: jimtang2/benchmarks/fastapi-psycopg
    build:
      context: .
      dockerfile: ./fastapi/Dockerfile
      args:
        SOURCE_PATH: fastapi/psycopg
    container_name: bench-fastapi-psycopg-pool
    ports:
      - "8080:8080"
    volumes:
      - ./config.with-pool.yaml:/config/config.yaml
    depends_on:
      - postgres

  express-node-postgres:
    image: jimtang2/benchmarks/express
    build:
      context: .
      dockerfile: ./express/Dockerfile
      args:
        SOURCE_PATH: express/node-postgres
    container_name: bench-express-node-postgres
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  express-porsager-postgres:
    image: jimtang2/benchmarks/express
    build:
      context: .
      dockerfile: ./express/Dockerfile
      args:
        SOURCE_PATH: express/porsager
    container_name: bench-express-porsager-postgres
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  express-porsager-postgres-pool:
    image: jimtang2/benchmarks/express
    build:
      context: .
      dockerfile: ./express/Dockerfile
      args:
        SOURCE_PATH: express/porsager
    container_name: bench-express-porsager-pool
    ports:
      - "8080:8080"
    volumes:
      - ./config.with-pool.yaml:/config/config.yaml
    depends_on:
      - postgres

  next:
    image: jimtang2/benchmarks/next
    build:
      context: .
      dockerfile: ./next/Dockerfile
    container_name: bench-next
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  spring:
    image: jimtang2/benchmarks/spring
    build:
      context: .
      dockerfile: ./spring/Dockerfile
    container_name: bench-spring
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    environment:
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres:password@postgres:5432/demo
      - JAVA_TOOL_OPTIONS= \
        -XX:+UseZGC \
        -XX:+ZGenerational \
        -XX:+UnlockExperimentalVMOptions \
        -XX:+UseTransparentHugePages \
        -XX:MaxRAMPercentage=85 \
        -Dreactor.netty.ioWorkerCount=8 \
        -Dreactor.netty.ioSelectCount=8 \
        -Dio.netty.eventLoopThreads=8

  spring-pool:
    image: jimtang2/benchmarks/spring
    build:
      context: .
      dockerfile: ./spring/Dockerfile
    container_name: bench-spring-pool
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    environment:
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres:password@pgcat:6432/demo
      - JAVA_TOOL_OPTIONS=-XX:+UseZGC -XX:+ZGenerational -XX:+UnlockExperimentalVMOptions -XX:+UseTransparentHugePages -XX:MaxRAMPercentage=85 -Dreactor.netty.ioWorkerCount=8 -Dreactor.netty.ioSelectCount=8 -Dio.netty.eventLoopThreads=8

  rust-axum:
    image: jimtang2/benchmarks/rust-axum
    build:
      context: .
      dockerfile: ./rust/Dockerfile
      args:
        SOURCE_PATH: axum
    container_name: bench-rust-axum
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  rust-actix:
    image: jimtang2/benchmarks/rust-actix
    build:
      context: .
      dockerfile: ./rust/Dockerfile
      args:
        TARGET: actix
    container_name: bench-rust-actix
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres

  rust-actix-pool:
    image: jimtang2/benchmarks/rust-actix
    build:
      context: .
      dockerfile: ./rust/Dockerfile
      args:
        TARGET: actix
    container_name: bench-rust-actix-pool
    ports:
      - "8080:8080"
    volumes:
      - ./config.with-pool.yaml:/config/config.yaml
    depends_on:
      - postgres

  rust-hyper:
    image: jimtang2/benchmarks/rust-hyper
    build:
      context: .
      dockerfile: ./rust/Dockerfile
      args:
        TARGET: hyper
    container_name: bench-rust-hyper
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/config/config.yaml
    depends_on:
      - postgres
